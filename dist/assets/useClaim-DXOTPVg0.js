import{r as M}from"./react-CxzTU07i.js";import{f as O,q as Z,d as x,E,p as H,aa as $,a9 as I,L as j,$ as K,h as p,b as ee,s as V,a0 as te,k as ne,T as z}from"./App-Cb960mne.js";import{O as ie,T as ae}from"./@initia-CP5FTFDk.js";import{u as S}from"./position-DDE7YBux.js";import{b as q,M as J,l as Y,o as X,s as oe,P as re}from"./@tucana-network-DgPNddlX.js";import{B}from"./bn.js-CjHYPH1W.js";import{u as se}from"./useGetTokenInfo-Cwtmo1XH.js";import{u as A}from"./RectangularTab-scmnr4k8.js";import{b as ce,f as le}from"./useApiUrl-BWcjgV84.js";import"./numbro-DbF9-lIv.js";import{f as de}from"./react-router-COZMEyo_.js";function ge(){const{tucanaSpotSDK:P}=O(),R=ie(),{setPositionList:m,positionList:h,setPositionObj:_,positionListLoading:f,setPositionListLoading:d,setPositionTotalAmount:s}=S(),{poolsObj:w,poolList:L}=Z();async function g(a){console.log("getPositionList start"),d(!0);try{const o=[],e=Object.fromEntries(a==null?void 0:a.map(r=>[r==null?void 0:r.id,r])),t=a==null?void 0:a.map(r=>r.object.position_collection);console.log("getPositionList positionCollectionList: ",t);const k=await(P==null?void 0:P.Position.getPositionList(R,t||[]));console.log("getPositionList address: ",R),console.log("getPositionList res: ",k),k==null||k.forEach(r=>{var u,y,b,T;const i=e[r.pool_address];if(console.log("getPositionList poolInfo: ",e),i){const v=r.tick_lower_index===q.getInitializableTickIndex(J,i.tickSpacing)?"0":q.tickIndexToPrice(r.tick_lower_index,(u=i==null?void 0:i.token0)==null?void 0:u.decimals,(y=i==null?void 0:i.token1)==null?void 0:y.decimals).toString(),C=r.tick_upper_index===q.getInitializableTickIndex(Y,i.tickSpacing)?"∞":q.tickIndexToPrice(r.tick_upper_index,(b=i==null?void 0:i.token0)==null?void 0:b.decimals,(T=i==null?void 0:i.token1)==null?void 0:T.decimals).toString(),F=i!=null&&i.isReverse?C==="∞"?"0":x(1).div(C).toString():v,D=i!=null&&i.isReverse?v==="0"?"∞":x(1).div(v).toString():C;o.push({posId:r==null?void 0:r.id,displayToken0:i.displayToken0,displayToken1:i==null?void 0:i.displayToken1,token0:i==null?void 0:i.token0,token1:i==null?void 0:i.token1,minPrice:E(F,6,!0),maxPrice:E(D,6,!0),feeTier:i==null?void 0:i.feeTier,showRewarder:i==null?void 0:i.showRewarder,showFarming:i==null?void 0:i.showFarming,...r})}}),console.log("getPositionList positionList: ",o),m(o);const l=Object.fromEntries(o==null?void 0:o.map(r=>[r==null?void 0:r.posId,r]));return _(l),d(!1),s(o==null?void 0:o.length),o}catch(o){d(!1),m([]),_({}),console.log("usePositionList getPositionList Error: ",o)}}function c(a){console.log("getHavePoolPosition positions: ",a),console.log("getHavePoolPosition poolsObj: ",w);const o=a==null?void 0:a.filter(e=>w[e==null?void 0:e.pool_address]);return console.log("getHavePoolPosition res: ",o),o}const n=M.useCallback(async()=>{if(R&&h&&L&&L.length>0){if(h.length>0){const t=c(h);return s((t==null?void 0:t.length)||0),(t==null?void 0:t.length)||0}const a=L==null?void 0:L.map(t=>t.object.position_collection),o=await(P==null?void 0:P.Position.getPositionList(R,a||[])),e=c(o);return s((e==null?void 0:e.length)||0),(e==null?void 0:e.length)||0}return s(0),0},[R,h.length,L.length]);return{getPositionList:g,getPositionAmount:n}}function ue(){const{tucanaSpotSDK:P}=O(),{getCointAmountValue:R}=H(),{setLiquidityPriceObj:m,setTotalLiquidityPrice:h,setPositionLiquidityPriceLoading:_}=S(),f=()=>{m({}),h("")};return{calcLiquidityPrice:$,getLiquidityPrice:async s=>{if(!s||(s==null?void 0:s.length)===0){f();return}_(!0);try{const w={},L=s==null?void 0:s.map(e=>e==null?void 0:e.pool_address),g=Array.from(new Set(L));console.log("getLiquidityPrice poolIds: ",g);const c=g.map(e=>P==null?void 0:P.Pool.getPool(e)),n=await Promise.all(c);console.log("getLiquidityPrice poolList: ",n);const a=Object.fromEntries(n==null?void 0:n.map(e=>[e==null?void 0:e.pool_address,e]));console.log("getLiquidityPrice poolsObj: ",a);let o="0";return s==null||s.forEach(e=>{var C,F,D,N,G,U;const t=a==null?void 0:a[e==null?void 0:e.pool_address],k=q.sqrtPriceX64ToPrice(new B(t==null?void 0:t.current_sqrt_price),(C=e==null?void 0:e.token0)==null?void 0:C.decimals,(F=e==null?void 0:e.token1)==null?void 0:F.decimals),l=I(t==null?void 0:t.current_tick_index,e.tick_lower_index,e.tick_upper_index),r=$(e.liquidity,t.current_sqrt_price,e==null?void 0:e.tick_lower_index,e==null?void 0:e.tick_upper_index),i=j(r==null?void 0:r.coinA,e.token0.decimals),u=j(r==null?void 0:r.coinB,e.token1.decimals),y=i?R(i,(D=e==null?void 0:e.token0)==null?void 0:D.metadata,6,!0):"0",b=u?R(u,(N=e==null?void 0:e.token1)==null?void 0:N.metadata,6,!0):"0",T=y!=="--"&&b!=="--"?x(y).add(b).toString():"--",v=((G=e==null?void 0:e.token0)==null?void 0:G.metadata)===((U=e==null?void 0:e.displayToken0)==null?void 0:U.metadata);w[e==null?void 0:e.posId]={poolAddress:e==null?void 0:e.pool_address,token0:e==null?void 0:e.token0,token1:e==null?void 0:e.token1,coinAmount0:i,coinAmount1:u,coinAmount0Rate:y,coinAmount1Rate:b,liquidityRate:T==="--"?"--":K(T,2),total:T,status:l,currentPrice:String(v?E(k==null?void 0:k.toString(),6,!0):E(x(1).div(k).toString(),6,!0)),currentSqrtPrice:t==null?void 0:t.current_sqrt_price,currentTickIndex:t==null?void 0:t.current_tick_index},o=o==="--"||T==="--"?"--":x(o).add(T).toString()}),console.log("getLiquidityPrice liquidityPriceObj: ",w),h(o),m(w),_(!1),w}catch(w){f(),_(!1),console.log("getLiquidityPrice Error: ",w)}}}}function Q(){const{tucanaSpotSDK:P}=O(),{getCointAmountValue:R}=H(),{setPositionFeeObj:m,positionFeeObj:h,setTotalPositionFee:_,setPositionFeeLoading:f,setPositionFeeLoadingObj:d}=S(),s=()=>{m({}),_("")};function w(g){let c="0";for(const n in g){const a=g[n];c=c==="--"||a.total==="--"?"--":x(c).add(a.total).toString(),_(c)}}return{getPositionFee:async(g,c=!0)=>{if(!g||(g==null?void 0:g.length)===0){s();return}c?f(!0):d({[g[0].id]:!0});try{const n=g==null?void 0:g.map(t=>t==null?void 0:t.id),a=await(P==null?void 0:P.Position.calculatePositionFee(n));console.log("getPositionFee feeObj: ",a),console.log("getPositionFee positions: ",g);const o={};let e="0";if(g==null||g.forEach(t=>{var b,T,v,C,F;const k=a==null?void 0:a[t==null?void 0:t.id],l=j(new B(k==null?void 0:k.fee_owned_a),(b=t==null?void 0:t.token0)==null?void 0:b.decimals),r=j(new B(k==null?void 0:k.fee_owned_b),(T=t==null?void 0:t.token1)==null?void 0:T.decimals),i=R(l,(v=t==null?void 0:t.token0)==null?void 0:v.metadata,6,!0),u=R(r,(C=t==null?void 0:t.token1)==null?void 0:C.metadata,6,!0),y=i==="--"||u==="--"?"--":(F=x(i))==null?void 0:F.add(u).toString();o[t==null?void 0:t.id]={poolAddress:t==null?void 0:t.pool_address,token0:t==null?void 0:t.token0,token1:t==null?void 0:t.token1,fee0:l,fee1:r,fee0Rate:i,fee1Rate:u,total:y},e=e==="--"||y==="--"?"--":x(e).add(y).toString()}),console.log("getPositionFee result: ",o),console.log("getPositionFee totalFeeRate: ",e),c)m(o),_(e),f(!1);else{const t={...h,...o};m(t),d({[g.id]:!1}),w(t)}return o}catch(n){if(c)s(),f(!1);else{const a=h;delete a[g.id],m({...a}),d({[g.id]:!1})}console.log("getPositionFee Error: ",n)}}}}function W(){const{tucanaSpotSDK:P}=O(),{getCointAmountValue:R}=H(),{getTokenInfo:m}=se(),{setPosRewardsObj:h,posRewardsObj:_,setTotalRewards:f,setPositionRewardsLoading:d,setPositionRewardsLoadingObj:s}=S(),w=()=>{h({}),f("")};function L(c){let n="0";for(const a in c){const o=c[a];n=n==="--"||o.sumRewardsRate==="--"?"--":x(n).add(o.sumRewardsRate).toString(),f(n)}}return{getPositionRewards:async(c,n=!0)=>{if(!c||(c==null?void 0:c.length)===0){w();return}n?d(!0):s({[c.id]:!0});try{const o=(c==null?void 0:c.filter(l=>(l==null?void 0:l.showRewarder.length)>0)).map(l=>l==null?void 0:l.id);console.log("getPositionRewards positions: ",c),console.log("getPositionRewards posIds: ",o);const e=await(P==null?void 0:P.Position.calculatePositionRewards(o));console.log("getPositionRewards rewardsObj: ",e);const t={};let k="0";for(const l in e){const r=e[l],i=[];let u="0";for(let y=0;y<r.length;y++){const b=r[y],T=await m(b.reward_memadata),v=j(new B(b.reward_amount),T==null?void 0:T.decimals),C=R(v,b.reward_memadata,6,!0);i.push({...b,token:T,amount:v,amountRate:C}),u=C==="--"||u==="--"?"--":x(C).add(u).toString()}k=u==="--"||k==="--"?"--":x(u).add(k).toString(),t[l]={total:u,rewards:i,sumRewardsRate:u}}if(console.log("getPositionRewards result: ",t),n)h(t),f(k),d(!1);else{const l={..._,...t};h(l),L(l),s({[c.id]:!1})}return t}catch(a){if(console.log("getPositionRewards Error: ",a),n)w(),d(!1);else{const o=_;delete o[c.id],h({...o}),s({[c.id]:!1})}}}}}function Pe(){const P=p(),R=ce(le),{tucanaSpotSDK:m}=O();return{fetchClosedPositionData:async _=>{try{const f=new URLSearchParams;f.append("position_addr",_);const s=await(await fetch(`${R}?${f.toString()}`)).json();if(console.log("fetchClosedPositionData: ",s),s&&s.data&&s.data.list){const{package_id:w}=P.clmmPool,L=`${w.toLocaleLowerCase()}::pool::ClosePositionEvent`;if(s.data.list.filter(o=>o.event_type===L).length===0)return;const c={id:_,owner:"",uri:"",pool_address:"",position_index:"0",token_id:"",collection_id:"",liquidity:"0",tick_lower_index:0,tick_upper_index:0,fee_growth_inside_a:"0",fee_growth_inside_b:"0",fee_owned_a:"0",fee_owned_b:"0",rewards:[]},n=`${w.toLocaleLowerCase()}::pool::OpenPositionEvent`;let a;if(s.data.list.forEach(o=>{const e=JSON.parse(o.event_data);switch(o.event_type){case n:a=e.tx,c.tick_lower_index=X(BigInt(e.TickLower.bits)),c.tick_upper_index=X(BigInt(e.TickUpper.bits)),c.pool_address=e.PoolAddr;break;default:break}}),a&&m){const o=await(m==null?void 0:m.RPCClient.tx.txInfo(a)),e=oe(o.events,"move",{key:"type_tag",value:"0x1::collection::MintEvent"});if(e.length>0){const t=JSON.parse(e[0]);c.token_id=t.token_id,c.collection_id=t.collection,c.position_index=re.formatPositionIndex(c.token_id)}}return c}}catch(f){console.log(f,"fetchHistoryData")}}}}function me(){const{tucanaSpotSDK:P}=O(),{setPositionInfo:R,setPositionLoading:m}=S(),{getApiPoolInfo:h}=A(),{fetchClosedPositionData:_}=Pe();async function f(d,s){var w,L,g,c;console.log("getPositionInfo params poolId: ",d),console.log("getPositionInfo params posId: ",s),m(!0);try{const n=await h({id:d});console.log("getPositionInfo poolApiInfo: ",n);let a=await(P==null?void 0:P.Position.getPositionInfo(s));console.log("getPositionInfo posContractIfno1: ",a),a===void 0&&(a=await _(s),console.log("getPositionInfo posContractIfno2: ",a));const o=a.tick_lower_index===q.getInitializableTickIndex(J,n.tickSpacing)?"0":q.tickIndexToPrice(a==null?void 0:a.tick_lower_index,(w=n==null?void 0:n.token0)==null?void 0:w.decimals,(L=n==null?void 0:n.token1)==null?void 0:L.decimals).toString(),e=(a==null?void 0:a.tick_upper_index)===q.getInitializableTickIndex(Y,n.tickSpacing)?"∞":q.tickIndexToPrice(a==null?void 0:a.tick_upper_index,(g=n==null?void 0:n.token0)==null?void 0:g.decimals,(c=n==null?void 0:n.token1)==null?void 0:c.decimals).toString();console.log("getPositionInfo min max: ",o,e);const t=n!=null&&n.isReverse?e==="∞"?"0":x(1).div(e).toString():o,k=n!=null&&n.isReverse?o==="0"?"∞":x(1).div(o).toString():e;console.log("getPositionInfo minPrice maxPrice: ",t,k,n==null?void 0:n.isReverse);const l={posId:s,displayToken0:n.displayToken0,displayToken1:n==null?void 0:n.displayToken1,token0:n==null?void 0:n.token0,token1:n==null?void 0:n.token1,minPrice:E(t,6,!0),maxPrice:E(k,6,!0),feeTier:n==null?void 0:n.feeTier,showRewarder:n==null?void 0:n.showRewarder,showFarming:n==null?void 0:n.showFarming,...a};return console.log("getPositionInfo positionInfo: ",l),R(l),m(!1),l}catch(n){console.log("getPositionInfo Error: ",s,n),m(!1);return}}return{getPositionInfo:f}}function we(P){const{getApiPoolInfo:R}=A(),{getPositionList:m,getPositionAmount:h}=ge(),{getLiquidityPrice:_}=ue(),{getPositionFee:f}=Q(),{getPositionRewards:d}=W(),{positionInfo:s,setCurrentPoolInfo:w,setPositionList:L,setLiquidityPriceObj:g,setPositionFeeObj:c,setPosRewardsObj:n,setPositionLoading:a,setPositionListLoading:o,setClaimAllSubmitLoading:e}=S(),{getPositionInfo:t}=me();return{getPositionListData:u=>{m(u).then(y=>{console.log("getPositionList success: ",y),_(y),f(y),d(y)})},resetPositionListData:()=>{L([]),g(void 0),c(void 0),n(void 0),o(!1),e(!1)},getPositionInfoData:(u,y)=>{t(u,y).then(b=>{console.log("Position Page pos: ",b),a(!1),b&&(_([b]),f([b]),d([b]))})},getPositionAmount:h,getCurrentPoolInfo:u=>{R({id:s==null?void 0:s.pool_address},u).then(y=>{w(y)})}}}function ke(){const{id:P,pid:R}=de(),{address:m}=ae(),{fetchTokenBalances:h}=ee(),{getPositionInfoData:_}=we();async function f(){!m||!P||!R||(await V(2e3),h(),await _(P,R))}return{refreshPositionData:f}}function qe(){const{getPositionRewards:P}=W(),{getPositionFee:R}=Q(),{refreshPositionData:m}=ke(),{getCollectRewardsPaylod:h,getCollectFeePaylod:_}=te(),{signAndExecuteTransaction:f}=ne(),{positionInfo:d,positionFeeObj:s,posRewardsObj:w,claimFeeAndRewardsSubmitLoading:L,setClaimFeeAndRewardsSubmitLoading:g}=S(),c=async()=>{g(!0);try{if(d!=null&&d.posId){const l=[],r=h({pid:d==null?void 0:d.posId});console.log("handleSubmitClaim collectRewardsPayload: ",r);const i=_({pid:d==null?void 0:d.posId});console.log("handleSubmitClaim collectFeePayload: ",i),e&&i&&l.push(i),t&&r&&l.push(r);const u=await f(l,{action:z.Claim,description:"Claim Yield"});m(),g(!1),console.log("handleSubmitClaim response: ",u)}}catch(l){console.log("handleSubmitClaim error: ",l),g(!1)}},n=async l=>{g(!0);try{const r=[],i=h({pid:l.posId}),u=_({pid:l.posId});a(l.posId)&&u&&r.push(u),o(l.posId)&&i&&r.push(i),console.log("handleSubmitClaim msgs: ",r);const y=await f(r,{action:z.Claim,description:"Claim Yield"});await V(2e3),P([l],!1),R([l],!1),g(!1),console.log("handleSubmitClaim response: ",y)}catch(r){console.log("handleSubmitClaim error: ",r),g(!1)}},a=l=>{var r,i;return!!(l&&(x((r=s==null?void 0:s[l])==null?void 0:r.fee0).gt(0)||x((i=s==null?void 0:s[l])==null?void 0:i.fee1).gt(0)))},o=l=>{var r;if(l){const i=(r=w==null?void 0:w[l])==null?void 0:r.rewards;if(i&&(i!=null&&i.find(u=>x(u.amount).gt(0))))return!0}return!1},e=M.useMemo(()=>L?!1:a(d==null?void 0:d.posId),[L,s,d==null?void 0:d.posId]),t=M.useMemo(()=>L?!1:o(d==null?void 0:d.posId),[L,w,d==null?void 0:d.posId]),k=M.useMemo(()=>!e&&!t,[e,t,d]);return{handleSubmitClaim:c,isDisabledClaimBtn:k,handleSubmitClaimClick:n,hasFee:e,hasRewards:t,hasFeeAmount:a,hassRewardAmount:o}}export{Q as a,we as b,qe as c,ke as d,W as u};
