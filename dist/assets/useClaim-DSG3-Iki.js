import{K as q,a0 as W,O as A,r as E,Q as v,aY as X,aZ as V,v as x,i as F,aQ as M,a$ as G,W as K,a_ as I,U as j,ar as p,m as ee,c2 as te,a5 as ne,c3 as $,c4 as ae,c5 as ie,Z as re,a6 as oe,a1 as se,s as Y,as as ce,_ as le,a4 as z}from"./index-BNs6X6_J.js";import{u as D,a as J}from"./RectangularTab-fIKyUaw1.js";import{u as de}from"./useGetTokenInfo-CYV53wae.js";function ue(){const{tucanaSpotSDK:S}=q(),f=W(),{setPositionList:h,positionList:w,setPositionObj:P,positionListLoading:y,setPositionListLoading:o,setPositionTotalAmount:c}=D(),{poolsObj:_}=A();async function L(t){console.log("getPositionList start"),o(!0);try{const a=[],r=Object.fromEntries(t==null?void 0:t.map(l=>[l==null?void 0:l.id,l])),e=await S.Position.getPositionList(f);console.log("getPositionList address: ",f),console.log("getPositionList res: ",e),e==null||e.forEach(l=>{var u,k,g,m;const n=r[l.pool_address];if(console.log("getPositionList poolInfo: ",r),n){const R=l.tick_lower_index===v.getInitializableTickIndex(X,n.tickSpacing)?"0":v.tickIndexToPrice(l.tick_lower_index,(u=n==null?void 0:n.token0)==null?void 0:u.decimals,(k=n==null?void 0:n.token1)==null?void 0:k.decimals).toString(),b=l.tick_upper_index===v.getInitializableTickIndex(V,n.tickSpacing)?"∞":v.tickIndexToPrice(l.tick_upper_index,(g=n==null?void 0:n.token0)==null?void 0:g.decimals,(m=n==null?void 0:n.token1)==null?void 0:m.decimals).toString(),C=n!=null&&n.isReverse?b==="∞"?"0":x(1).div(b).toString():R,T=n!=null&&n.isReverse?R==="0"?"∞":x(1).div(R).toString():b;a.push({posId:l==null?void 0:l.id,displayToken0:n.displayToken0,displayToken1:n==null?void 0:n.displayToken1,token0:n==null?void 0:n.token0,token1:n==null?void 0:n.token1,minPrice:F(C,6,!0),maxPrice:F(T,6,!0),feeTier:n==null?void 0:n.feeTier,showRewarder:n==null?void 0:n.showRewarder,showFarming:n==null?void 0:n.showFarming,...l})}}),console.log("getPositionList positionList: ",a),h(a);const i=Object.fromEntries(a==null?void 0:a.map(l=>[l==null?void 0:l.posId,l]));return P(i),o(!1),c(a==null?void 0:a.length),a}catch(a){o(!1),h([]),P({}),console.log("usePositionList getPositionList Error: ",a)}}function s(t){console.log("getHavePoolPosition positions: ",t),console.log("getHavePoolPosition poolsObj: ",_);const a=t==null?void 0:t.filter(r=>_[r==null?void 0:r.pool_address]);return console.log("getHavePoolPosition res: ",a),a}const d=E.useCallback(async()=>{if(f&&w){if(w.length>0){const r=s(w);return c((r==null?void 0:r.length)||0),(r==null?void 0:r.length)||0}const t=await S.Position.getPositionList(f),a=s(t);return c((a==null?void 0:a.length)||0),(a==null?void 0:a.length)||0}return c(0),0},[f,w.length]);return{getPositionList:L,getPositionAmount:d}}function ge(){const{tucanaSpotSDK:S}=q(),{getCointAmountValue:f}=M(),{setLiquidityPriceObj:h,setTotalLiquidityPrice:w,setPositionLiquidityPriceLoading:P}=D(),y=()=>{h({}),w("")};return{calcLiquidityPrice:G,getLiquidityPrice:async c=>{if(!c||(c==null?void 0:c.length)===0){y();return}P(!0);try{const _={},L=c==null?void 0:c.map(e=>e==null?void 0:e.pool_address),s=Array.from(new Set(L));console.log("getLiquidityPrice poolIds: ",s);const d=s.map(e=>S.Pool.getPool(e)),t=await Promise.all(d);console.log("getLiquidityPrice poolList: ",t);const a=Object.fromEntries(t==null?void 0:t.map(e=>[e==null?void 0:e.pool_address,e]));console.log("getLiquidityPrice poolsObj: ",a);let r="0";return c==null||c.forEach(e=>{var T,O,H,N,B,U;const i=a[e==null?void 0:e.pool_address],l=v.sqrtPriceX64ToPrice(new K(i==null?void 0:i.current_sqrt_price),(T=e==null?void 0:e.token0)==null?void 0:T.decimals,(O=e==null?void 0:e.token1)==null?void 0:O.decimals),n=I(i==null?void 0:i.current_tick_index,e.tick_lower_index,e.tick_upper_index),u=G(e.liquidity,i.current_sqrt_price,e==null?void 0:e.tick_lower_index,e==null?void 0:e.tick_upper_index),k=j(u==null?void 0:u.coinA,e.token0.decimals),g=j(u==null?void 0:u.coinB,e.token1.decimals),m=k?f(k,(H=e==null?void 0:e.token0)==null?void 0:H.metadata,6,!0):"0",R=g?f(g,(N=e==null?void 0:e.token1)==null?void 0:N.metadata,6,!0):"0",b=m!=="--"&&R!=="--"?x(m).add(R).toString():"--",C=((B=e==null?void 0:e.token0)==null?void 0:B.metadata)===((U=e==null?void 0:e.displayToken0)==null?void 0:U.metadata);_[e==null?void 0:e.posId]={poolAddress:e==null?void 0:e.pool_address,token0:e==null?void 0:e.token0,token1:e==null?void 0:e.token1,coinAmount0:k,coinAmount1:g,coinAmount0Rate:m,coinAmount1Rate:R,liquidityRate:b==="--"?"--":p(b,2),total:b,status:n,currentPrice:String(C?F(l==null?void 0:l.toString(),6,!0):F(x(1).div(l).toString(),6,!0)),currentSqrtPrice:i==null?void 0:i.current_sqrt_price,currentTickIndex:i==null?void 0:i.current_tick_index},r=r==="--"||b==="--"?"--":x(r).add(b).toString()}),console.log("getLiquidityPrice liquidityPriceObj: ",_),w(r),h(_),P(!1),_}catch(_){y(),P(!1),console.log("getLiquidityPrice Error: ",_)}}}}function Q(){const{tucanaSpotSDK:S}=q(),{getCointAmountValue:f}=M(),{setPositionFeeObj:h,positionFeeObj:w,setTotalPositionFee:P,setPositionFeeLoading:y,setPositionFeeLoadingObj:o}=D(),c=()=>{h({}),P("")};function _(s){let d="0";for(const t in s){const a=s[t];d=d==="--"||a.total==="--"?"--":x(d).add(a.total).toString(),P(d)}}return{getPositionFee:async(s,d=!0)=>{if(!s||(s==null?void 0:s.length)===0){c();return}d?y(!0):o({[s[0].id]:!0});try{const t=s==null?void 0:s.map(i=>i==null?void 0:i.id),a=await S.Position.calculatePositionFee(t);console.log("getPositionFee feeObj: ",a),console.log("getPositionFee positions: ",s);const r={};let e="0";if(s==null||s.forEach(i=>{var R,b,C,T,O;const l=a[i==null?void 0:i.id],n=j(new K(l==null?void 0:l.fee_owned_a),(R=i==null?void 0:i.token0)==null?void 0:R.decimals),u=j(new K(l==null?void 0:l.fee_owned_b),(b=i==null?void 0:i.token1)==null?void 0:b.decimals),k=f(n,(C=i==null?void 0:i.token0)==null?void 0:C.metadata,6,!0),g=f(u,(T=i==null?void 0:i.token1)==null?void 0:T.metadata,6,!0),m=k==="--"||g==="--"?"--":(O=x(k))==null?void 0:O.add(g).toString();r[i==null?void 0:i.id]={poolAddress:i==null?void 0:i.pool_address,token0:i==null?void 0:i.token0,token1:i==null?void 0:i.token1,fee0:n,fee1:u,fee0Rate:k,fee1Rate:g,total:m},e=e==="--"||m==="--"?"--":x(e).add(m).toString()}),console.log("getPositionFee result: ",r),console.log("getPositionFee totalFeeRate: ",e),d)h(r),P(e),y(!1);else{const i={...w,...r};h(i),o({[s.id]:!1}),_(i)}return r}catch(t){if(d)c(),y(!1);else{const a=w;delete a[s.id],h({...a}),o({[s.id]:!1})}console.log("getPositionFee Error: ",t)}}}}function Z(){const{tucanaSpotSDK:S}=q(),{getCointAmountValue:f}=M(),{getTokenInfo:h}=de(),{setPosRewardsObj:w,posRewardsObj:P,setTotalRewards:y,setPositionRewardsLoading:o,setPositionRewardsLoadingObj:c}=D(),_=()=>{w({}),y("")};function L(d){let t="0";for(const a in d){const r=d[a];t=t==="--"||r.sumRewardsRate==="--"?"--":x(t).add(r.sumRewardsRate).toString(),y(t)}}return{getPositionRewards:async(d,t=!0)=>{if(!d||(d==null?void 0:d.length)===0){_();return}t?o(!0):c({[d.id]:!0});try{const r=(d==null?void 0:d.filter(n=>(n==null?void 0:n.showRewarder.length)>0)).map(n=>n==null?void 0:n.id);console.log("getPositionRewards positions: ",d),console.log("getPositionRewards posIds: ",r);const e=await S.Position.calculatePositionRewards(r);console.log("getPositionRewards rewardsObj: ",e);const i={};let l="0";for(const n in e){const u=e[n],k=[];let g="0";for(let m=0;m<u.length;m++){const R=u[m],b=await h(R.reward_memadata),C=j(new K(R.reward_amount),b==null?void 0:b.decimals),T=f(C,R.reward_memadata,6,!0);k.push({...R,token:b,amount:C,amountRate:T}),g=T==="--"||g==="--"?"--":x(T).add(g).toString()}l=g==="--"||l==="--"?"--":x(g).add(l).toString(),i[n]={total:g,rewards:k,sumRewardsRate:g}}if(console.log("getPositionRewards result: ",i),t)w(i),y(l),o(!1);else{const n={...P,...i};w(n),L(n),c({[d.id]:!1})}return i}catch(a){if(console.log("getPositionRewards Error: ",a),t)_(),o(!1);else{const r=P;delete r[d.id],w({...r}),c({[d.id]:!1})}}}}}function Pe(){const S=ee(te),{tucanaSpotSDK:f}=q();return{fetchClosedPositionData:async w=>{try{const P=new URLSearchParams;P.append("position_addr",w);const o=await(await fetch(`${S}?${P.toString()}`)).json();if(console.log("fetchClosedPositionData: ",o),o&&o.data&&o.data.list){const{package_id:c}=ne.clmmPool,_=`${c.toLocaleLowerCase()}::pool::ClosePositionEvent`;if(o.data.list.filter(a=>a.event_type===_).length===0)return;const s={id:w,owner:"",uri:"",pool_address:"",position_index:"0",token_id:"",collection_id:"",liquidity:"0",tick_lower_index:0,tick_upper_index:0,fee_growth_inside_a:"0",fee_growth_inside_b:"0",fee_owned_a:"0",fee_owned_b:"0",rewards:[]},d=`${c.toLocaleLowerCase()}::pool::OpenPositionEvent`;let t;if(o.data.list.forEach(a=>{const r=JSON.parse(a.event_data);switch(a.event_type){case d:t=r.tx,s.tick_lower_index=$(BigInt(r.TickLower.bits)),s.tick_upper_index=$(BigInt(r.TickUpper.bits)),s.pool_address=r.PoolAddr;break;default:break}}),t){const a=await f.RPCClient.tx.txInfo(t),r=ae(a.events,"move",{key:"type_tag",value:"0x1::collection::MintEvent"});if(r.length>0){const e=JSON.parse(r[0]);s.token_id=e.token_id,s.collection_id=e.collection,s.position_index=ie.formatPositionIndex(s.token_id)}}return s}}catch(P){console.log(P,"fetchHistoryData")}}}}function we(){const{tucanaSpotSDK:S}=q(),{setPositionInfo:f,setPositionLoading:h}=D(),{getApiPoolInfo:w}=J(),{fetchClosedPositionData:P}=Pe();async function y(o,c){var _,L,s,d;console.log("getPositionInfo params poolId: ",o),console.log("getPositionInfo params posId: ",c),h(!0);try{const t=await w({id:o});console.log("getPositionInfo poolApiInfo: ",t);let a=await S.Position.getPositionInfo(c);console.log("getPositionInfo posContractIfno1: ",a),a===void 0&&(a=await P(c),console.log("getPositionInfo posContractIfno2: ",a));const r=a.tick_lower_index===v.getInitializableTickIndex(X,t.tickSpacing)?"0":v.tickIndexToPrice(a==null?void 0:a.tick_lower_index,(_=t==null?void 0:t.token0)==null?void 0:_.decimals,(L=t==null?void 0:t.token1)==null?void 0:L.decimals).toString(),e=(a==null?void 0:a.tick_upper_index)===v.getInitializableTickIndex(V,t.tickSpacing)?"∞":v.tickIndexToPrice(a==null?void 0:a.tick_upper_index,(s=t==null?void 0:t.token0)==null?void 0:s.decimals,(d=t==null?void 0:t.token1)==null?void 0:d.decimals).toString();console.log("getPositionInfo min max: ",r,e);const i=t!=null&&t.isReverse?e==="∞"?"0":x(1).div(e).toString():r,l=t!=null&&t.isReverse?r==="0"?"∞":x(1).div(r).toString():e;console.log("getPositionInfo minPrice maxPrice: ",i,l,t==null?void 0:t.isReverse);const n={posId:c,displayToken0:t.displayToken0,displayToken1:t==null?void 0:t.displayToken1,token0:t==null?void 0:t.token0,token1:t==null?void 0:t.token1,minPrice:F(i,6,!0),maxPrice:F(l,6,!0),feeTier:t==null?void 0:t.feeTier,showRewarder:t==null?void 0:t.showRewarder,showFarming:t==null?void 0:t.showFarming,...a};return console.log("getPositionInfo positionInfo: ",n),f(n),h(!1),n}catch(t){console.log("getPositionInfo Error: ",c,t),h(!1);return}}return{getPositionInfo:y}}function ke(S){const{getApiPoolInfo:f}=J(),{getPositionList:h,getPositionAmount:w}=ue(),{getLiquidityPrice:P}=ge(),{getPositionFee:y}=Q(),{getPositionRewards:o}=Z(),{positionInfo:c,setCurrentPoolInfo:_,setPositionList:L,setLiquidityPriceObj:s,setPositionFeeObj:d,setPosRewardsObj:t,setPositionLoading:a,setPositionListLoading:r,setClaimAllSubmitLoading:e}=D(),{getPositionInfo:i}=we();return{getPositionListData:g=>{h(g).then(m=>{console.log("getPositionList success: ",m),P(m),y(m),o(m)})},resetPositionListData:()=>{L([]),s(void 0),d(void 0),t(void 0),r(!1),e(!1)},getPositionInfoData:(g,m)=>{i(g,m).then(R=>{console.log("Position Page pos: ",R),a(!1),R&&(P([R]),y([R]),o([R]))})},getPositionAmount:w,getCurrentPoolInfo:g=>{f({id:c==null?void 0:c.pool_address},g).then(m=>{_(m)})}}}function _e(){const{id:S,pid:f}=re(),{address:h}=oe(),{fetchTokenBalances:w}=se(),{getPositionInfoData:P}=ke();async function y(){!h||!S||!f||(await Y(2e3),w(),await P(S,f))}return{refreshPositionData:y}}function ye(){const{getPositionRewards:S}=Z(),{getPositionFee:f}=Q(),{refreshPositionData:h}=_e(),{getCollectRewardsPaylod:w,getCollectFeePaylod:P}=ce(),{signAndExecuteTransaction:y}=le(),{positionInfo:o,positionFeeObj:c,posRewardsObj:_,claimFeeAndRewardsSubmitLoading:L,setClaimFeeAndRewardsSubmitLoading:s}=D(),d=async()=>{s(!0);try{if(o!=null&&o.posId){const n=[],u=w({pid:o==null?void 0:o.posId});console.log("handleSubmitClaim collectRewardsPayload: ",u);const k=P({pid:o==null?void 0:o.posId});console.log("handleSubmitClaim collectFeePayload: ",k),e&&n.push(k),i&&n.push(u);const g=await y(n,{action:z.Claim,description:"Claim Yield"});h(),s(!1),console.log("handleSubmitClaim response: ",g)}}catch(n){console.log("handleSubmitClaim error: ",n),s(!1)}},t=async n=>{s(!0);try{const u=[],k=w({pid:n.posId}),g=P({pid:n.posId});a(n.posId)&&u.push(g),r(n.posId)&&u.push(k),console.log("handleSubmitClaim msgs: ",u);const m=await y(u,{action:z.Claim,description:"Claim Yield"});await Y(2e3),S([n],!1),f([n],!1),s(!1),console.log("handleSubmitClaim response: ",m)}catch(u){console.log("handleSubmitClaim error: ",u),s(!1)}},a=n=>{var u,k;return!!(n&&(x((u=c==null?void 0:c[n])==null?void 0:u.fee0).gt(0)||x((k=c==null?void 0:c[n])==null?void 0:k.fee1).gt(0)))},r=n=>{var u;if(n){const k=(u=_==null?void 0:_[n])==null?void 0:u.rewards;if(k&&(k!=null&&k.find(g=>x(g.amount).gt(0))))return!0}return!1},e=E.useMemo(()=>L?!1:a(o==null?void 0:o.posId),[L,c,o==null?void 0:o.posId]),i=E.useMemo(()=>L?!1:r(o==null?void 0:o.posId),[L,_,o==null?void 0:o.posId]),l=E.useMemo(()=>!e&&!i,[e,i,o]);return{handleSubmitClaim:d,isDisabledClaimBtn:l,handleSubmitClaimClick:t,hasFee:e,hasRewards:i,hasFeeAmount:a,hassRewardAmount:r}}export{Q as a,ke as b,ye as c,_e as d,Z as u};
